除了复杂度，互联网业务发展的另外两个关键特点是“高性能”和“高可用”。通常情况下，我们在设计高可用和高性能系统的时候，主要关注点在系统本身的复杂度，然后通过各种手段来实现高可用和高性能的要求，例如我前面介绍的计算高性能架构模式、存储高可用架构模式等。但是当我们站在一个公司的的角度来思考架构的时候，单个系统的高可用和高性能并不等于整体业务的高可用和高性能，互联网业务的高性能和高可用需要从更高的角度去设计，这个高点就是“网络”，所以我将相关措施统一划归为“网络层”。注意这里的网络层和通常理解的如何搭建一个局域网这种概念不一样，这里强调的是站在网络层的角度整体设计架构，而不是某个具体网络的搭建。

接下来我将介绍互联网架构模板的“网络层”技术的几个关键架构设计点，部分内容专栏前面已经有深入阐述，今天作为概要的总结把它们归纳一下。

## 负载均衡

顾名思议，负载均衡就是将请求均衡地分配到多个系统上。使用负载均衡的原因也很简单：每个系统的处理能力是有限的，为了应对大容量的访问，必须使用多个系统。例如，一台32核64GB内存的机器，性能测试数据显示每秒处理Hello World的HTTP请求不超过2万，实际业务机器处理HTTP请求每秒可能才几百QPS，而互联网业务并发超过1万是比较常见的，遇到双十一、过年发红包这些极端场景，每秒可以达到几十万的请求。

1.DNS

DNS是最简单也是最常见的负载均衡方式，一般用来实现地理级别的均衡。例如，北方的用户访问北京的机房，南方的用户访问广州的机房。一般不会使用DNS来做机器级别的负载均衡，因为太耗费IP资源了。例如，百度搜索可能要10000台以上机器，不可能将这么多机器全部配置公网IP，然后用DNS来做负载均衡。有兴趣的读者可以在Linux用“dig baidu.com”命令看看实际上用了几个IP地址。

DNS负载均衡的优点是通用（全球通用）、成本低（申请域名，注册DNS即可），但缺点也比较明显，主要体现在：

- DNS缓存的时间比较长，即使将某台业务机器从DNS服务器上删除，由于缓存的原因，还是有很多用户会继续访问已经被删除的机器。
- DNS不够灵活。DNS不能感知后端服务器的状态，只能根据配置策略进行负载均衡，无法做到更加灵活的负载均衡策略。比如说某台机器的配置比其他机器要好很多，理论上来说应该多分配一些请求给它，但DNS无法做到这一点。

所以对于时延和故障敏感的业务，有实力的公司可能会尝试实现**HTTP-DNS**的功能，即使用HTTP协议实现一个私有的DNS系统。HTTP-DNS主要应用在通过App提供服务的业务上，因为在App端可以实现灵活的服务器访问策略，如果是Web业务，实现起来就比较麻烦一些，因为URL的解析是由浏览器来完成的，只有Javascript的访问可以像App那样实现比较灵活的控制。

HTTP-DNS的优缺点有：

- 灵活：HTTP-DNS可以根据业务需求灵活的设置各种策略。
- 可控：HTTP-DNS是自己开发的系统，IP更新、策略更新等无需依赖外部服务商。
- 及时：HTTP-DNS不受传统DNS缓存的影响，可以非常快地更新数据、隔离故障。
- 开发成本高：没有通用的解决方案，需要自己开发。
- 侵入性：需要App基于HTTP-DNS进行改造。

2.Nginx 、LVS 、F5

DNS用于实现地理级别的负载均衡，而Nginx、LVS、F5用于同一地点内机器级别的负载均衡。其中Nginx是软件的7层负载均衡，LVS是内核的4层负载均衡，F5是硬件的4层负载均衡。

软件和硬件的区别就在于性能，硬件远远高于软件，Ngxin的性能是万级，一般的Linux服务器上装个Nginx大概能到5万/秒；LVS的性能是十万级，没有具体测试过，据说可达到80万/秒；F5性能是百万级，从200万/秒到800万/秒都有。硬件虽然性能高，但是单台硬件的成本也很高，一台最便宜的F5都是几十万，但是如果按照同等请求量级来计算成本的话，实际上硬件负载均衡设备可能会更便宜，例如假设每秒处理100万请求，用一台F5就够了，但用Nginx，可能要20台，这样折算下来用F5的成本反而低。因此通常情况下，如果性能要求不高，可以用软件负载均衡；如果性能要求很高，推荐用硬件负载均衡。

4层和7层的区别就在于协议和灵活性。Nginx支持HTTP、E-mail协议，而LVS和F5是4层负载均衡，和协议无关，几乎所有应用都可以做，例如聊天、数据库等。

目前很多云服务商都已经提供了负载均衡的产品，例如阿里云的SLB、UCloud的ULB等，中小公司直接购买即可。

## CDN

CDN是为了解决用户网络访问时的“最后一公里”效应，本质上是一种“以空间换时间”的加速策略，即将内容缓存在离用户最近的地方，用户访问的是缓存的内容，而不是站点实时的内容。

下面是简单的CDN请求流程示意图：

![](https://static001.geekbang.org/resource/image/78/33/78bc9b6fba23f495db9b595a45693833.png?wh=2560%2A1600 "图片来自网络")

CDN经过多年的发展，已经变成了一个很庞大的体系：分布式存储、全局负载均衡、网络重定向、流量控制等都属于CDN的范畴，尤其是在视频、直播等领域，如果没有CDN，用户是不可能实现流畅观看内容的。

幸运的是，大部分程序员和架构师都不太需要深入理解CDN的细节，因为CDN作为网络的基础服务，独立搭建的成本巨大，很少有公司自己设计和搭建CDN系统，从CDN服务商购买CDN服务即可，目前有专门的CDN服务商，例如网宿和蓝汛；也有云计算厂家提供CDN服务，例如阿里云和腾讯云都提供CDN的服务。

## 多机房

从架构上来说，单机房就是一个全局的网络单点，在发生比较大的故障或者灾害时，单机房难以保证业务的高可用。例如，停电、机房网络中断、地震、水灾等都有可能导致一个机房完全瘫痪。

多机房设计最核心的因素就是如何处理时延带来的影响，常见的策略有：

1.同城多机房

同一个城市多个机房，距离不会太远，可以投入重金，搭建私有的高速网络，基本上能够做到和同机房一样的效果。

这种方式对业务影响很小，但投入较大，如果不是大公司，一般是承受不起的；而且遇到极端的地震、水灾等自然灾害，同城多机房也是有很大风险的。

2.跨城多机房

在不同的城市搭建多个机房，机房间通过网络进行数据复制（例如，MySQL主备复制），但由于跨城网络时延的问题，业务上需要做一定的妥协和兼容，比如不需要数据的实时强一致性，只是保证最终一致性。

例如，微博类产品，B用户关注了A用户，A用户在北京机房发布了一条微博，B在广州机房不需要立刻看到A用户发的微博，等10分钟看到也可以。

这种方式实现简单，但和业务有很强的相关性，微博可以这样做，支付宝的转账业务就不能这样做，因为用户余额是强一致性的。

3.跨国多机房

和跨城多机房类似，只是地理上分布更远，时延更大。由于时延太大和用户跨国访问实在太慢，跨国多机房一般仅用于备份和服务本国用户。

## 多中心

多中心必须以多机房为前提，但从设计的角度来看，多中心相比多机房是本质上的飞越，难度也高出一个等级。

简单来说，多机房的主要目标是灾备，当机房故障时，可以比较快速地将业务切换到另外一个机房，这种切换操作允许一定时间的中断（例如，10分钟、1个小时），而且业务也可能有损失（例如，某些未同步的数据不能马上恢复，或者要等几天才恢复，甚至永远都不能恢复了）。因此相比多机房来说，多中心的要求就高多了，要求每个中心都同时对外提供服务，且业务能够自动在多中心之间切换，故障后不需人工干预或者很少的人工干预就能自动恢复。

多中心设计的关键就在于“数据一致性”和“数据事务性”如何保证，这两个难点都和业务紧密相关，目前没有很成熟的且通用的解决方案，需要基于业务的特性进行详细的分析和设计。以淘宝为例，淘宝对外宣称自己是多中心的，但是在实际设计过程中，商品浏览的多中心方案、订单的多中心方案、支付的多中心方案都需要独立设计和实现。

正因为多中心设计的复杂性，不一定所有业务都能实现多中心，目前国内的银行、支付宝这类系统就没有完全实现多中心，不然也不会出现挖掘机一铲子下去，支付宝中断4小时的故障。

有关多中心设计更详细的内容，你可以查看专栏第[28](http://time.geekbang.org/column/article/9787)、[29](http://time.geekbang.org/column/article/10199)、[30](http://time.geekbang.org/column/article/10204)期的内容。

## 小结

今天我为你讲了互联网架构模板中的“网络层”技术，希望对你有所帮助。

这就是今天的全部内容，留一道思考题给你吧，为什么可以购买负载均衡和CDN服务，但却不能购买多机房和多中心服务？

欢迎你把答案写到留言区，和我一起讨论。相信经过深度思考的回答，也会让你对知识的理解更加深刻。（编辑乱入：精彩的留言有机会获得丰厚福利哦！）
<div><strong>精选留言（15）</strong></div><ul>
<li><span>narry</span> 👍（70） 💬（1）<p>负载均衡和cdn基本是和业务无关，具有通用性，而每个业务对数据的一致性和事务要求都不一样，需要单独设计，所以无法将多机房和多中心作为基础服务对外提供</p>2018-08-02</li><br/><li><span>J</span> 👍（31） 💬（5）<p>老师你好，请教一个问题，像车联网这种业务，拥有上百万的车载终端，车端会实时上传当前数据，同时服务器会需要控制单独某台车（下行消息），这种场景一般采用哪种架构呢？如果采用MQ的话，一般的消息中间件只能支持几千上万的队列，满足不了要求，请老师指点，谢谢🙏</p>2018-09-04</li><br/><li><span>许鑫</span> 👍（18） 💬（3）<p>想问下，类似支付宝的场景如何保证异地金额的强一致性</p>2018-08-07</li><br/><li><span>钱</span> 👍（16） 💬（1）<p>课后思考及问题
1：为什么可以购买负载均衡和 CDN 服务，但却不能购买多机房和多中心服务？
这个问题，我第一感觉是个伪问题，商业社会没什么不能买的，土地、房屋、武器、公司都能买卖，多机房和多中心服务更如是。
当然也理解老师的意思，主要是站在架构师的角度来看，负载均衡和CDN与业务关联性小，花钱也相对少，买来直接就能用，需要的也多一些，所以，购买使用比较顺当自然。
多机房和多中心服务，实现上和业务关联性大，除非订制化否则难以买来就用，如果自己的公司都发展到必须使用多机房和多中心了，招兵买马自己搞一套才是自然而然的想法。</p>2019-09-04</li><br/><li><span>SMTCode</span> 👍（15） 💬（1）<p>CDN和LB是基于通用技术和协议，实现请求的调度与转发等功能。而多机房、多中心，是与业务强相关，对业务有很大侵入性的，只能是服务的实现者根据自己的侧重点，选择合适的技术，有针对性的实现服务的三高指标。</p>2018-08-02</li><br/><li><span>kyq叶鑫</span> 👍（13） 💬（1）<p>老师你好，你在评论或者专栏中多次说道金融类业务无法做到跨城强一致性，并以支付宝举例，我一直有一个疑问：那么如果一个支付宝用户走出其数据所在大区，支付宝是如何处理这个用户的数据，保证业务不出错的呢？
望解惑。</p>2018-12-05</li><br/><li><span>LB</span> 👍（9） 💬（0）<p>仔仔老师你好，有两个问题请帮忙解答：
1.请问银行异地存取款的数据强一致性是怎么做到的？还可以在国外消费做到强一致性？
2.银行常用的两地三中心是真正的多中心吗？如何判断？
谢谢。</p>2018-08-06</li><br/><li><span>呵呵</span> 👍（6） 💬（2）<p>大神问两个问题，1.假如有很多台nginx做负载均衡，那么请求是如何分发到这么多nginx服务上的？2. 对于支付宝的转账业务，需要数据强一致性，那是不是就无法做到跨城市区域存储相关的数据？</p>2018-08-27</li><br/><li><span>凡凡</span> 👍（6） 💬（1）<p>多机房多中心，业务相关性太强，很难抽象绝对合适的模型，通用差。一般都是企业按照自己的特定业务，适当的做多中心，或者做到数据异地灾备，或者做到多中心服务。

或许，现在的云服务厂商，会逐渐面向行业，抽象出多种多中心方案，也是可能得。

毕竟云服务厂商在全球范围，已经有了很多机房，如果能抽象出来一定会做尝试的，不论用户多少，这是一种能力。</p>2018-08-05</li><br/><li><span>LB</span> 👍（5） 💬（1）<p>仔仔老师，服务器中间件的连接数有限，例如WAS的连接池一共有几千。而咱们说的一台服务器都并发好几万，请问是怎么搞的？谢谢。</p>2018-08-05</li><br/><li><span>LouisLimTJ</span> 👍（4） 💬（1）<p>其实谷歌有些产品号称可以做到同城和跨城高可用了，比如cloud Spanner，当然我没有在这些产品针对高可用的问题进行针对性的测试。
回到问题上来，主要第一. 想用的公司本来就少，方案贵；第二. 既然要用也是趋向自搭，可以针对业务进行定制化处理；第三. 个人看法，所提的问题层次最多是PaaS, 而既然同城跨城高可用跟业务有关，如果云平台技术实力强，不见得不可以考虑实现SaaS级别的跨城高可用</p>2018-08-06</li><br/><li><span>敬艺</span> 👍（4） 💬（1）<p>即使机房接入CDN，如果CDN支持的网络服务商不够的话，用户访问时不时出现超时。如CDN只接入电信和联通（一时很难覆盖所有网络服务商），用户使用移动网络，访问服务会出现超时。请问大致从几方面优化？</p>2018-08-05</li><br/><li><span>空档滑行</span> 👍（4） 💬（1）<p>负载均衡和cdn虽然复杂，但是局限于技术层面。多中心和多机房则是技术和业务都要涉及到改造，比如文中说的淘宝多中心业务，每个业务模块都要定制，所以提供通用服务是不现实的</p>2018-08-02</li><br/><li><span>正是那朵玫瑰</span> 👍（3） 💬（2）<p>华仔老师：
1、DNS负载均衡不一定是地里级别的吧，如consul就实现了dns服务器，内部服务注册到consul，消费者调用服务可以通过dns服务器做负载均衡，服务故障下线也能及时更新！
2、cdn和负载均衡应该是通用的技术吧，多机房和多中心跟业务强关联，没法抽象通用的东西来，就算能，使用起来也不灵活吧！</p>2018-08-02</li><br/><li><span>Monday</span> 👍（2） 💬（1）<p>dig baidu.com

结果 ：

; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.13-Ubuntu &lt;&lt;&gt;&gt; baidu.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 47856
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4000
;; QUESTION SECTION:
;baidu.com.                     IN      A

;; ANSWER SECTION:
baidu.com.              300     IN      A       220.181.38.148
baidu.com.              300     IN      A       39.156.69.79

;; Query time: 8 msec
;; SERVER: 172.16.237.4#53(172.16.237.4)
;; WHEN: Fri Oct 16 10:23:55 CST 2020
;; MSG SIZE  rcvd: 70</p>2020-10-16</li><br/>
</ul>